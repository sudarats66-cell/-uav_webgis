<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‚òï ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å</title>

  <!-- Fonts + Icons + Leaflet -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå CSS ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
  <link rel="stylesheet" href="styles_cafe.css">
</head>

<body>
  <!-- Header / Top frame -->
  <header class="site-header">
    <div class="header-left">
      <div class="brand-logo" aria-hidden="true">‚òï</div>
      <div class="header-title">
        <h1>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å</h1>
        <p>  ‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏î‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</p>
      </div>
    </div>

    <div class="header-actions" role="toolbar" aria-label="header actions">
      <div class="icon-btn" title="Layer control">
        <i class="fa-solid fa-layer-group"></i>
      </div>
      <div class="icon-btn" title="About">
        <i class="fa-solid fa-circle-info"></i>
      </div>
    </div>
  </header>

  <div id="map"></div>

  <!-- Toggle button for panel -->
  <button class="toggle-panel-btn" id="togglePanelBtn" aria-expanded="true">
    <i class="fa-solid fa-magnifying-glass-location"></i>
    <span style="font-weight:600">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô</span>
  </button>

  <!-- Query panel (bottom-left) -->
  <div class="query-panel" id="queryPanel" role="region" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô">
    <h3>
      <span><i class="fa-solid fa-search-location"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô</span>
      <button id="closePanel" style="background:none;border:none;font-size:14px;cursor:pointer" title="‡∏õ‡∏¥‡∏î">‚úï</button>
    </h3>

    <label for="distance">‡∏£‡∏±‡∏®‡∏°‡∏µ (‡πÄ‡∏°‡∏ï‡∏£):</label>
    <input type="number" id="distance" value="1000" min="100" max="5000" step="100" />

    <div style="display:flex;gap:8px;">
      <button id="search-btn" class="btn"><i class="fa-solid fa-magnifying-glass-location"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <button id="reset-btn" class="btn secondary"><i class="fa-solid fa-rotate-left"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    </div>

    <div style="margin-top:8px;font-size:13px;color:#666;">
      ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    </div>
  </div>

  <div class="site-footer">
    <i class="fa-solid fa-map-location-dot"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü ‚Äî ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
  </div>

  <script>
    // =========================
    // Map Initialization (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    // =========================
    var map = L.map('map').setView([16.812063159227716, 100.25759788323138], 11);

    var baseLayers = {
      "OpenStreetMap": L.tileLayer
      ('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '¬© OpenStreetMap contributors'
      }).addTo(map),
      
      "Carto Light": L.tileLayer
      ('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }),

      "Esri Imagery": L.tileLayer
      ('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
    };

    // =========================
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    // =========================
    var coffeeLayer = L.layerGroup().addTo(map);
    fetch("json_sql.php")
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          pointToLayer: (f, latlng) => L.circleMarker(latlng, {
            radius: 6, color: "#6B4F3B", fillColor: "#C19A6B", fillOpacity: 0.9
          }),
          onEachFeature: (f, layer) => {
            layer.bindPopup(`
              <b>${f.properties.name}</b><br>
              ${f.properties.address || '-'}<br>
              ‚≠ê ${f.properties.rating || '-'} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            `);
          }
        }).addTo(coffeeLayer);
      });

    var markerClick = null;
    var nearbyLayer = null;

    function findNearby(lat, lng, distance) {
      if (nearbyLayer) map.removeLayer(nearbyLayer);

      fetch(`query.php?lat=${lat}&lng=${lng}&distance=${distance}`)
        .then(res => res.json())
        .then(data => {
          if (!data.features || data.features.length === 0) {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ô‡∏µ‡πâ");
            return;
          }

          nearbyLayer = L.geoJSON(data, {
            onEachFeature: (f, layer) => {
              const coords = f.geometry.coordinates;
              const lat = coords[1].toFixed(5);
              const lng = coords[0].toFixed(5);
              const dist = f.properties.distance_m.toLocaleString();
              layer.bindPopup(`
                <b>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:</b> ${f.properties.name}<br>
                <b>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${lat}, ${lng}<br>
                <b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${f.properties.address || '-'}<br>
                ‚≠ê ${f.properties.rating || '-'} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô<br>
                üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${dist} ‡πÄ‡∏°‡∏ï‡∏£
              `);
            },
            pointToLayer: (f, latlng) => L.marker(latlng, {
              icon: L.icon({
                iconUrl: "https://cdn-icons-png.flaticon.com/512/3565/3565418.png",
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                popupAnchor: [0, -36]
              })
            })
          }).addTo(map);

          map.fitBounds(nearbyLayer.getBounds(), { padding: [40, 40] });
        })
        .catch(err => console.error("Query error:", err));
    }

    // =========================
    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    // =========================
    var clickPoint = null;
    map.on("click", e => {
      if (clickPoint) map.removeLayer(clickPoint);
      if (nearbyLayer) map.removeLayer(nearbyLayer);

      clickPoint = L.marker(e.latlng).addTo(map)
        .bindPopup("üìç ‡∏à‡∏∏‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤<br>Lat: " + e.latlng.lat.toFixed(5) + "<br>Lng: " + e.latlng.lng.toFixed(5))
        .openPopup();

      document.getElementById("search-btn").onclick = function() {
        const dist = parseFloat(document.getElementById("distance").value);
        findNearby(e.latlng.lat, e.latlng.lng, dist);
      };
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
    document.getElementById("reset-btn").onclick = function() {
      if (clickPoint) map.removeLayer(clickPoint);
      if (nearbyLayer) map.removeLayer(nearbyLayer);
      map.setView([18.288, 99.507], 11);
    };

    // =========================
    // ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    // =========================
    map.on("dblclick", e => {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      const formHtml = `
        <div style="text-align:center;">
          <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡πÉ‡∏´‡∏°‡πà</h3>
          <input type='text' id='name' placeholder='‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô' style='margin:6px 0; padding:6px; width:90%'><br>
          <input type='text' id='address' placeholder='‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà' style='margin:6px 0; padding:6px; width:90%'><br>
          <input type='number' id='rating' placeholder='‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (0-5)' step='0.1' min='0' max='5' style='margin:6px 0; padding:6px; width:90%'><br>
          <button onclick='insertCoffee(${lat}, ${lng})' style='padding:8px 10px;border-radius:8px;background:#5a3f36;color:#fff;border:none;'>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>`;
      L.popup().setLatLng(e.latlng).setContent(formHtml).openOn(map);
    });

    function insertCoffee(lat, lng) {
      const name = $("#name").val();
      const address = $("#address").val();
      const rating = $("#rating").val();

      if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô");

      $.ajax({
        url: "insert.php",
        type: "POST",
        data: { name, address, latitude: lat, longitude: lng, rating },
        success: function() {
          alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          location.reload();
        },
        error: function(err) {
          console.error("Insert error:", err);
          alert("‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        }
      });
    }

    // Layer Control
    L.control.layers(baseLayers, { "‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü": coffeeLayer }).addTo(map);

    // =========================
    // Toggle panel (open/close) JS
    // =========================
    const toggleBtn = document.getElementById('togglePanelBtn');
    const queryPanel = document.getElementById('queryPanel');
    const closePanel = document.getElementById('closePanel');

    function openPanel() {
      queryPanel.classList.remove('hidden');
      toggleBtn.setAttribute('aria-expanded','true');
    }
    function closePanelFn() {
      queryPanel.classList.add('hidden');
      toggleBtn.setAttribute('aria-expanded','false');
    }

    toggleBtn.addEventListener('click', () => {
      if (queryPanel.classList.contains('hidden')) openPanel();
      else closePanelFn();
    });
    closePanel.addEventListener('click', closePanelFn);

    // default: panel ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å closePanelFn() ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
    // closePanelFn();
  </script>
</body>
</html>
